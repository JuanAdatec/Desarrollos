USE [COMORIENTE]
GO

/****** Object:  View [dbo].[CLIENTES_ERP]    Script Date: 12/07/2024 11:02:28 a.Â m. ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO








ALTER VIEW [dbo].[CLIENTES_ERP]
AS
SELECT     DISTINCT
	
	'807004655' EMPRESA_CODIGO,
	CLIENTE_CODIGO COLLATE Modern_Spanish_CI_AS  AS CLIENTE_CODIGO_REAL,
	LEFT(CASE 
		WHEN CLIENTE_CODIGO LIKE '%|%' THEN
			REPLACE(CLIENTE_CODIGO, '|','')
		ELSE
			CLIENTE_CODIGO
	END, 18) COLLATE Modern_Spanish_CI_AS  AS CLIENTE_CODIGO,
	LEFT(CLIENTE_TIPO, 30) COLLATE Modern_Spanish_CI_AS  AS CLIENTE_TIPO,
	LEFT(CLIENTE_NOMBRE, 150) COLLATE Modern_Spanish_CI_AS  AS CLIENTE_NOMBRE,
	LEFT(CLIENTE_CONTACTO, 150) COLLATE Modern_Spanish_CI_AS  AS CLIENTE_CONTACTO,
	LEFT(CLIENTE_TELEFONO, 100) COLLATE Modern_Spanish_CI_AS  AS CLIENTE_TELEFONO,
	LEFT(CLIENTE_EMAIL, 150) COLLATE Modern_Spanish_CI_AS  AS CLIENTE_EMAIL,
	isnull(CLIENTE_DIRECCION, '') COLLATE Modern_Spanish_CI_AS  AS CLIENTE_DIRECCION,
	LEFT(CLIENTE_CIUDAD, 50) COLLATE Modern_Spanish_CI_AS  AS CLIENTE_CIUDAD,
	LEFT(CLIENTE_REGION, 50) COLLATE Modern_Spanish_CI_AS  AS CLIENTE_REGION,
	CLIENTE_PAIS COLLATE Modern_Spanish_CI_AS  AS CLIENTE_PAIS,
	CLIENTE_CUPO AS CLIENTE_CUPO,
	LEFT(CLIENTE_FORMA_PAGO, 50) COLLATE Modern_Spanish_CI_AS  AS CLIENTE_FORMA_PAGO,
	CLIENTE_FORMA_PAGO_CODIGO COLLATE Modern_Spanish_CI_AS  AS CLIENTE_FORMA_PAGO_CODIGO,
	CASE WHEN CLIENTE_PLAZO > 999 THEN 999 ELSE  CLIENTE_PLAZO END AS CLIENTE_PLAZO,
	LISTA_CODIGO COLLATE Modern_Spanish_CI_AS  AS LISTA_CODIGO,
	CLIENTE_ESTADO COLLATE Modern_Spanish_CI_AS  AS CLIENTE_ESTADO,
	UBICACION COLLATE Modern_Spanish_CI_AS  AS UBICACION,
	CLIENTE_EMAIL2 COLLATE Modern_Spanish_CI_AS  AS CLIENTE_EMAIL2,
	DESCUENTO   AS DESCUENTO,
	LISTA_DESCUENTO COLLATE Modern_Spanish_CI_AS  AS LISTA_DESCUENTO,
	FUENTE COLLATE Modern_Spanish_CI_AS  AS FUENTE,
	NIT COLLATE Modern_Spanish_CI_AS  AS NIT,
	SUCURSAL COLLATE Modern_Spanish_CI_AS  AS SUCURSAL,
	PUNTO_ENVIO COLLATE Modern_Spanish_CI_AS  AS PUNTO_ENVIO,
	COMPANIA   AS COMPANIA,
	RN  AS RN,
	CO COLLATE Modern_Spanish_CI_AS  AS [CENTRO_OPERACION],
	[OBSERVACIONES] COLLATE Modern_Spanish_CI_AS AS [OBSERVACIONES],
	[CLIENTE_NOMBRE_EST] COLLATE Modern_Spanish_CI_AS AS [CLIENTE_NOMBRE_EST],
	[CLIENTE_NOMBRE_CORTO] COLLATE Modern_Spanish_CI_AS AS [CLIENTE_NOMBRE_CORTO],
	'N' [BLOQUEAR_VENTA_CLIENTE],
	DESCUENTO_COMERCIAL,
	f201_id_tipo_cli,
	BASE_DESCUENTO,
	DESCUENTO_COMERCIAL RETENCION,
	BASE_DESCUENTO BASE_RETENCION,
	f201_rowid_tercero,
	f015_id_pais COLLATE Modern_Spanish_CI_AS f015_id_pais,
	f015_id_depto COLLATE Modern_Spanish_CI_AS f015_id_depto,
	f015_id_ciudad COLLATE Modern_Spanish_CI_AS f015_id_ciudad

FROM   OPENQUERY ([SIESA-M1-SQLSW-DB13.CBM3OHOGEAJR.US-EAST-1.RDS.AMAZONAWS.COM],'
	SELECT     
		CAST(RTRIM(CM.F010_NIT) AS VARCHAR(18)) AS EMPRESA_CODIGO, 
		CAST(RTRIM(T .f200_id) + ''-'' + RTRIM(C.F201_ID_SUCURSAL)  AS VARCHAR(18)) AS CLIENTE_CODIGO, 
		ISNULL(CAST(RTRIM(CRM.F206_DESCRIPCION) AS VARCHAR(30)),''N/A'') AS CLIENTE_TIPO, 
		--CAST(CASE WHEN RTRIM(C.F201_DESCRIPCION_SUCURSAL) <> '''' THEN RTRIM(C.F201_DESCRIPCION_SUCURSAL) ELSE RTRIM(T.F200_NOMBRE_EST) END AS VARCHAR(150)) CLIENTE_NOMBRE, 
		CAST(RTRIM(T.f200_razon_social) + CASE WHEN RTRIM(T.f200_razon_social) <> RTRIM(C.F201_DESCRIPCION_SUCURSAL) THEN '' - '' +  RTRIM(C.F201_DESCRIPCION_SUCURSAL) ELSE '''' END AS VARCHAR(150)) CLIENTE_NOMBRE, 
		CAST(RTRIM(CN.F015_CONTACTO) AS VARCHAR(50)) AS CLIENTE_CONTACTO, 
		CAST(RTRIM(CN.F015_TELEFONO) AS VARCHAR(100)) AS CLIENTE_TELEFONO, 
		CAST(RTRIM(CN.F015_EMAIL) AS VARCHAR(150)) AS CLIENTE_EMAIL, 
		CAST(RTRIM(CN.F015_DIRECCION1) + '' '' + RTRIM(ISNULL(''- ''+b.[f014_descripcion], ''''))+'' ''+CAST(RTRIM(CY.F013_DESCRIPCION) AS VARCHAR(20)) AS VARCHAR(300)) AS CLIENTE_DIRECCION, 
		CAST(RTRIM(CY.F013_DESCRIPCION) AS VARCHAR(20)) AS CLIENTE_CIUDAD, 
		CAST(RTRIM(D .F012_DESCRIPCION) AS VARCHAR(20)) AS CLIENTE_REGION, 
		''COLOMBIA'' AS CLIENTE_PAIS, 
		C.F201_CUPO_CREDITO AS CLIENTE_CUPO, 
		CAST(RTRIM(CP.F208_DESCRIPCION) AS VARCHAR(50)) AS CLIENTE_FORMA_PAGO, 
		C.F201_ID_COND_PAGO AS CLIENTE_FORMA_PAGO_CODIGO, 
		CP.F208_DIAS_VCTO AS CLIENTE_PLAZO, 
		CAST(RTRIM(ISNULL(C.F201_ID_LISTA_PRECIO, ''001'')) AS VARCHAR(10)) LISTA_CODIGO, 
		CASE C.f201_ind_estado_activo WHEN ''1'' THEN ''Y'' ELSE ''N'' END AS CLIENTE_ESTADO, 
		isnull(RTRIM([f047_id_llave_ret]), '''') AS UBICACION, 
		f201_id_tipo_cli AS CLIENTE_EMAIL2, 
		0 AS DESCUENTO, 
		f201_id_co_movto_factura AS LISTA_DESCUENTO, 
		'''' AS FUENTE, 
		CAST(RTRIM(T .F200_NIT) AS VARCHAR(18)) AS NIT, 
		C.F201_ID_SUCURSAL AS SUCURSAL, 
		''000'' AS PUNTO_ENVIO, 
		C.F201_ID_CIA AS COMPANIA, 
		ROW_NUMBER() OVER (PARTITION BY CAST(RTRIM(T .f200_id)  + RTRIM(C.F201_ID_SUCURSAL)  AS VARCHAR(18))
                   ORDER BY CAST(RTRIM(T .f200_id) +  RTRIM(C.F201_ID_SUCURSAL)  AS VARCHAR(18))) AS RN, 
		F201_ID_CO_FACTURA AS CO,
		ISNULL(CN.f015_id_barrio, '''') [CLIENTE_NOMBRE_EST],
		isnull(RTRIM(CBR.[f047_id_clase_retencion]), '''') [CLIENTE_NOMBRE_CORTO],
		RTRIM(C.F201_NOTAS) [OBSERVACIONES],
		f201_id_tipo_cli,
		ISNULL([f040_tasa],0 )AS DESCUENTO_COMERCIAL ,
		LLR.f040_base_minima BASE_DESCUENTO,
		C.f201_rowid_tercero,
		c.f201_id_cia,
		f015_id_pais,
		f015_id_depto,
		f015_id_ciudad
FROM        
	[UnoEE_Comoriente_Real].[dbo].T201_MM_CLIENTES C with(nolock)  INNER JOIN [UnoEE_Comoriente_Real].[dbo].T200_MM_TERCEROS T with(nolock)  ON 
		C.F201_ROWID_TERCERO = T .F200_ROWID 
		AND C.F201_ID_CIA = T .F200_ID_CIA 
	INNER JOIN [UnoEE_Comoriente_Real].[dbo].T015_MM_CONTACTOS CN with(nolock)  ON 
		C.F201_ROWID_CONTACTO = CN.F015_ROWID 
		AND C.F201_ID_CIA = CN.F015_ID_CIA 
	INNER JOIN [UnoEE_Comoriente_Real].[dbo].T278_CO_TIPO_CLI TC with(nolock)  ON 
		convert(varchar, TC.F278_ID) = convert(varchar, C.F201_ID_TIPO_CLI )
		AND TC.F278_ID_CIA = C.F201_ID_CIA 
	INNER JOIN [UnoEE_Comoriente_Real].[dbo].T013_MM_CIUDADES CY with(nolock)  ON 
		CN.F015_ID_PAIS = CY.F013_ID_PAIS 
		AND CN.F015_ID_DEPTO = CY.F013_ID_DEPTO 
		AND CN.F015_ID_CIUDAD = CY.F013_ID 
	left JOIN [UnoEE_Comoriente_Real].[dbo].T012_MM_DEPTOS D with(nolock)  ON 
		CN.F015_ID_PAIS = D .F012_ID_PAIS 
		AND CN.F015_ID_DEPTO = D .F012_ID 
	inner JOIN [UnoEE_Comoriente_Real].[dbo].T208_MM_CONDICIONES_PAGO CP with(nolock)  ON 
		C.F201_ID_CIA = CP.F208_ID_CIA 
		AND C.F201_ID_COND_PAGO = CP.F208_ID 
	INNER JOIN [UnoEE_Comoriente_Real].[dbo].T010_MM_COMPANIAS CM with(nolock)  ON 
		C.F201_ID_CIA = CM.F010_ID 
	LEFT JOIN  [UnoEE_Comoriente_Real].[dbo].[t047_mm_cliente_base_retencion] CBR with(nolock)  ON
		C.f201_id_cia= CBR.[f047_id_cia] 
		AND C.[f201_rowid_tercero] = CBR.f047_rowid_tercero 
		AND C.[f201_id_sucursal] = CBR.[f047_id_sucursal] 
		AND [f047_id_llave_ret] IN (''2044'', ''2040'')
	LEFT JOIN [UnoEE_Comoriente_Real].[dbo].[t040_mm_llaves_retencion] LLR with(nolock)  ON 
		LLR.[f040_id_cia] = C.f201_id_cia 
		AND LLR.[f040_id_clase_retencion] =  CBR.[f047_id_clase_retencion] 
		AND  [f040_id] = [f047_id_llave_ret]
	LEFT JOIN [UnoEE_Comoriente_Real].[dbo].[t207_mm_criterios_clientes] CRC with(nolock) ON 
		CRC.f207_rowid_tercero = T .F200_ROWID 
		AND CRC.F207_ID_CIA = T .F200_ID_CIA 
	INNER JOIN [UnoEE_Comoriente_Real].[dbo].[t206_mm_criterios_mayores] CRM with(nolock) ON 
		CRC.f207_id_criterio_mayor = CRM.f206_id
	LEFT JOIN [UnoEE_Comoriente_Real].[dbo].[t014_mm_barrios] B with(nolock) ON 
		b.f014_id = CN.f015_id_barrio
WHERE     
             c.F201_ID_CIA = 1
			 AND [f207_id_plan_criterios] IN (''CAN'') ') AS C
WHERE     C.RN = 1 
AND CLIENTE_CODIGO NOT LIKE '%|%'						 





GO


